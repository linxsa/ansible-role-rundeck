---
# tasks file for rundeck
- name: include assert.yml
  include_tasks: assert.yml

- name: create rundeck directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  loop:
    - "{{ rundeck_rdeckbase }}"
    - "{{ rundeck_rdeckbase }}/etc"
    - "{{ rundeck_rdeckbase }}"

- name: download rundeck
  get_url:
    url: "{{ rundeck_download_url }}"
    dest: "{{ rundeck_rdeckbase }}/rundeck-{{ rundeck_version }}-{{ rundeck_release_date }}.war"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"

- name: unpack rundeck
  command: "java -jar {{ rundeck_war }} --installonly"
  become: yes
  become_user: "{{ rundeck_sys_user }}"
  args:
    chdir: "{{ rundeck_rdeckbase }}"
    creates: "{{ rundeck_rdeckbase }}/server"

- name: create rundeck service
  import_role:
    name: robertdebock.service

- name: configure rundeck properties
  lineinfile:
    dest: "{{ rundeck_rdeckbase }}/server/config/rundeck-config.properties"
    line: "{{ item.parameter }} = {{ item.value }}"
    regexp: "^{{ item.parameter }}"
    create: yes
    mode: "0644"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  notify:
    - restart rundeck
  loop: "{{ rundeck_config }}"
  loop_control:
    label: "{{ item.parameter }}"

- name: configure rundeck framework
  lineinfile:
    dest: "{{ rundeck_rdeckbase }}/etc/framework.properties"
    line: "{{ item.parameter }} = {{ item.value }}"
    regexp: "^{{ item.parameter }}"
    create: yes
    mode: "0644"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  notify:
    - restart rundeck
  loop: "{{ rundeck_framework + rundeck_framework_extra }}"
  loop_control:
    label: "{{ item.parameter }}"

- name: configure rundeck admin policy
  template:
    src: admin.aclpolicy.j2
    dest: "{{ rundeck_rdeckbase }}/etc/admin.aclpolicy"
    mode: "0644"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  notify:
    - restart rundeck

- name: configure rundeck default users
  template:
    src: realm.properties.j2
    dest: "{{ rundeck_rdeckbase }}/server/config/realm.properties"
    mode: "0644"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  notify:
    - restart rundeck

- name: create /opt/rundeck/libext
  file:
    path: /opt/rundeck/libext
    state: directory
    mode: "0755"
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"

- name: install plugins
  get_url:
    url: "{{ item }}"
    dest: /opt/rundeck/libext
    owner: "{{ rundeck_sys_user }}"
    group: "{{ rundeck_sys_group }}"
  loop: "{{ rundeck_plugins }}"
  when: rundeck_plugins is defined

- name: start rundeck
  service:
    name: rundeck
    state: started
    enabled: yes
